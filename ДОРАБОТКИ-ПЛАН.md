# План доработок DonationApp для продакшена

> **Дата анализа:** 01.11.2025
> **Версия проекта:** 0.1.0

---

## Итоговая оценка

### Качество кода: 7.5/10

**Сильные стороны:**

- Хорошая архитектура и разделение ответственности
- Качественная типизация TypeScript (strict mode)
- Продуманная валидация через Zod
- Соблюдение DRY принципа
- Правильное использование Composition API и Pinia

**Недостатки:**

- `useDonationStore` нарушает Single Responsibility (268 строк, слишком много ответственности)
- Компоненты жестко связаны со store (tight coupling)
- Присутствуют magic strings вместо typed constants
- TODO комментарии в production коде

### Готовность к продакшену: 3/10

**Критические проблемы:**

- ❌ Отсутствует backend integration (axios есть, но не используется)
- ❌ Нет .env конфигурации и переменных окружения
- ❌ Нет обработки ошибок (error boundary, global handler)
- ❌ Недостаточная SEO оптимизация (нет title, meta tags, robots.txt)
- ❌ Отсутствуют security меры (CSP, CORS, санитизация)
- ❌ Нет production конфигурации

**Временная оценка:** 3-4 недели доработки перед production запуском.

---

## Приоритет 1: КРИТИЧНО (без этого нельзя деплоить)

### 1. Backend Integration & API Layer

**Задачи:**

- [ ] Создать структуру API service слоя `src/services/api/`
  - `donationService.ts` - submitDonation, getDonationById, getDonationStatus
  - `paymentService.ts` - processPayment, verifyPayment, getPaymentStatus
  - `apiClient.ts` - axios instance с базовой конфигурацией
- [ ] Интегрировать платежную систему (СБП, банковские карты)
- [ ] Добавить обработку ответов API (success/error states)
- [ ] Реализовать retry логику для запросов (например, с exponential backoff)
- [ ] Настроить timeout для запросов
- [ ] Добавить request/response interceptors

**Файлы для создания:**

- `src/services/api/apiClient.ts`
- `src/services/api/donationService.ts`
- `src/services/api/paymentService.ts`
- `src/services/api/types.ts`

---

### 2. Environment Configuration

**Задачи:**

- [ ] Создать `.env.example` с необходимыми переменными:

  ```bash
  # API Configuration
  VITE_API_URL=https://api.example.com
  VITE_API_TIMEOUT=30000

  # Payment Gateway
  VITE_PAYMENT_API_KEY=your_payment_api_key
  VITE_PAYMENT_WEBHOOK_URL=https://your-domain.com/api/webhook

  # Analytics
  VITE_ANALYTICS_ID=UA-XXXXXXXXX-X
  VITE_YANDEX_METRIKA_ID=XXXXXXXX

  # Sentry
  VITE_SENTRY_DSN=https://xxx@sentry.io/xxx
  VITE_SENTRY_ENVIRONMENT=production

  # App Configuration
  VITE_APP_URL=https://your-domain.com
  ```

- [ ] Добавить `.env` в `.gitignore` (если еще не добавлен)
- [ ] Создать отдельные конфиги для окружений:

  - `.env.development`
  - `.env.staging`
  - `.env.production`

- [ ] Настроить типизацию для `import.meta.env` в `src/vite-env.d.ts`

**Файлы для создания:**

- `.env.example`
- `.env.development`
- `.env.production`

---

### 3. Error Handling

**Задачи:**

- [ ] Создать `ErrorBoundary.vue` компонент для перехвата runtime ошибок
- [ ] Добавить глобальный error handler в `main.ts`
- [ ] Создать `useErrorHandler` composable для унифицированной обработки ошибок
- [ ] Реализовать user-friendly сообщения об ошибках
- [ ] Добавить fallback UI для критических ошибок
- [ ] Создать error logger utility (с интеграцией Sentry)
- [ ] Добавить обработку network errors
- [ ] Настроить toast уведомления для ошибок API

**Файлы для создания:**

- `src/components/common/ErrorBoundary.vue`
- `src/composables/useErrorHandler.ts`
- `src/lib/utils/errorLogger.ts`

---

### 4. SEO оптимизация

**Задачи:**

- [ ] Добавить `<title>` в `index.html`
- [ ] Добавить базовые meta теги в `index.html`:
  ```html
  <meta name="description" content="..." />
  <meta name="keywords" content="пожертвования, благотворительность, Чилгази" />
  <meta name="author" content="Фонд Чилгази" />
  <meta name="theme-color" content="#..." />
  ```
- [ ] Создать `public/robots.txt`
  ```
  User-agent: *
  Allow: /
  Sitemap: https://your-domain.com/sitemap.xml
  ```
- [ ] Создать `public/sitemap.xml` (статичный или динамический)
- [ ] Добавить Open Graph изображение (`public/og-image.jpg`)
- [ ] Обновить `guards.ts` для использования OG image
- [ ] Добавить structured data (JSON-LD) для главной страницы
- [ ] Проверить правильность canonical URLs

**Файлы для создания:**

- `public/robots.txt`
- `public/sitemap.xml`
- `public/og-image.jpg` (1200x630px)

---

### 5. Security

**Задачи:**

- [ ] Добавить Content Security Policy headers (через nginx или Vite plugin)
- [ ] Настроить CORS правильно на бэкенде
- [ ] Добавить санитизацию user input (библиотека DOMPurify или встроенная)
- [ ] Настроить HTTPS (Let's Encrypt сертификаты)
- [ ] Добавить security headers:
  - `X-Frame-Options: DENY`
  - `X-Content-Type-Options: nosniff`
  - `Referrer-Policy: strict-origin-when-cross-origin`
  - `Permissions-Policy`
- [ ] Защита от XSS атак
- [ ] Настроить rate limiting на API (backend)
- [ ] Добавить CSRF защиту для форм (когда будет бэкенд)

**Файлы для создания:**

- `vite-plugin-security-headers.ts` (опционально)
- Обновить nginx конфиг

---

## Приоритет 2: ВАЖНО (сделать перед запуском)

### 6. Deployment Configuration

**Задачи:**

- [ ] Создать production `vite.config.ts` или использовать conditional config
  ```typescript
  export default defineConfig(({ mode }) => ({
    // Разная конфигурация для dev/prod
  }))
  ```
- [ ] Настроить nginx конфиг для SPA:
  ```nginx
  location / {
    try_files $uri $uri/ /index.html;
  }
  ```
- [ ] Создать `Dockerfile` и `docker-compose.yml` (опционально)
- [ ] Написать deploy инструкции в `DEPLOY.md`
- [ ] Настроить CI/CD pipeline (GitHub Actions):
  - Автоматический build на push в main
  - Lint и type check
  - E2E тесты
  - Deploy на staging/production
- [ ] Настроить automated backups
- [ ] Создать rollback strategy

**Файлы для создания:**

- `nginx.conf`
- `Dockerfile` (опционально)
- `docker-compose.yml` (опционально)
- `.github/workflows/deploy.yml`
- `DEPLOY.md`

---

### 7. Logging & Monitoring

**Задачи:**

- [ ] Интегрировать Sentry для error tracking

  ```typescript
  // main.ts
  import * as Sentry from '@sentry/vue'

  Sentry.init({
    app,
    dsn: import.meta.env.VITE_SENTRY_DSN,
    environment: import.meta.env.VITE_SENTRY_ENVIRONMENT,
  })
  ```

- [ ] Добавить Google Analytics или Yandex Metrika
- [ ] Создать logger utility (`src/lib/utils/logger.ts`)

  - Разные уровни логирования (info, warn, error)
  - Отправка логов на сервер в production

- [ ] Настроить performance monitoring (Web Vitals)
- [ ] Добавить user analytics (события, конверсии)
- [ ] Настроить alerts для критических ошибок

**Файлы для создания:**

- `src/lib/utils/logger.ts`
- `src/plugins/analytics.ts`

---

### 8. Performance Optimization

**Задачи:**

- [ ] Оптимизировать изображения:
  - `public/img/hero.jpg` - сжать и создать WebP версию
  - `src/assets/logo.png` - оптимизировать размер
- [ ] Добавить lazy loading для images (`loading="lazy"`)
- [ ] Настроить code splitting (уже есть через Vite)
- [ ] Проверить bundle size:
  ```bash
  pnpm build
  pnpm vite-bundle-visualizer
  ```
- [ ] Добавить compression (gzip/brotli) на nginx
- [ ] Настроить кеширование статики (Cache-Control headers)
- [ ] Использовать CDN для статических ресурсов (опционально)
- [ ] Добавить preload для критических ресурсов
- [ ] Оптимизировать fonts loading

**Файлы для обновления:**

- `public/img/hero.jpg` → `hero.webp`
- `nginx.conf` (compression, caching)

---

### 9. Завершить функциональность

**Задачи:**

- [ ] Реализовать `ResultForm.vue` с реальными данными платежа
  - Отображение номера транзакции
  - Статус платежа (успешно/ошибка)
  - Кнопка "Скачать чек" (PDF)
  - Кнопка "Отправить чек на email"
- [ ] Добавить email уведомления (опционально):
  - Подтверждение пожертвования
  - Чек на email
- [ ] Создать admin панель для просмотра пожертвований (опционально)
- [ ] Реализовать webhook handler для платежных систем
- [ ] Добавить возможность отмены платежа

**Файлы для обновления:**

- `src/components/donation/forms/ResultForm.vue`

---

### 10. Accessibility

**Задачи:**

- [ ] Добавить `aria-label` для кнопок без текста
- [ ] Добавить `aria-describedby` для полей с ошибками
- [ ] Проверить keyboard navigation (Tab, Enter, Escape)
- [ ] Добавить focus management:
  - Автофокус на первое поле при открытии формы
  - Возврат фокуса после закрытия диалогов
- [ ] Проверить screen reader support (NVDA, JAWS)
- [ ] Добавить skip links для основного контента
- [ ] Проверить контрастность цветов (WCAG AA)
- [ ] Добавить visible focus indicators
- [ ] Тестировать с включенным motion reduction

**Инструменты:**

- Lighthouse Accessibility audit
- axe DevTools
- WAVE browser extension

---

## Приоритет 3: ХОРОШО ИМЕТЬ (можно после запуска)

### 11. Code Quality Improvements

**Задачи:**

- [ ] Рефакторинг `useDonationStore`:
  - Разбить на `useBlankFormStore` и `usePaymentFormStore`
  - Вынести валидацию в отдельный composable
  - Вынести step management в отдельный composable
- [ ] Убрать magic strings:
  ```typescript
  // Вместо
  donationStore.clearFieldError('blank', 'phone')
  // Использовать
  const FORM_NAMES = { BLANK: 'blank', PAYMENT: 'payment' } as const
  const FIELD_NAMES = { PHONE: 'phone', NAME: 'name', ... } as const
  ```
- [ ] Удалить TODO комментарии (заменить на реальную логику)
- [ ] Добавить JSDoc комментарии для сложных функций
- [ ] Настроить ESLint и Prettier (если еще нет)
- [ ] Добавить pre-commit hooks (husky + lint-staged)

**Файлы для создания:**

- `src/stores/blankForm.ts`
- `src/stores/paymentForm.ts`
- `src/composables/useFormValidation.ts`
- `src/composables/useStepManagement.ts`
- `src/lib/constants/formNames.ts`

---

### 12. Unit Testing

**Задачи:**

- [ ] Добавить Vitest:
  ```bash
  pnpm add -D vitest @vue/test-utils jsdom
  ```
- [ ] Написать unit тесты для stores:
  - `donation.spec.ts`
  - `settings.spec.ts`
- [ ] Написать unit тесты для composables:
  - `usePhone.spec.ts`
  - `useSEO.spec.ts`
  - `usePageLeaveConfirm.spec.ts`
- [ ] Написать unit тесты для utils и validations:
  - `phone.spec.ts`
  - `date.spec.ts`
  - `blank.validation.spec.ts`
  - `payment.validation.spec.ts`
- [ ] Настроить coverage reporting (80%+ coverage цель)
- [ ] Добавить script в `package.json`:
  ```json
  "test:unit": "vitest",
  "test:coverage": "vitest --coverage"
  ```

**Файлы для создания:**

- `vitest.config.ts`
- `src/stores/__tests__/donation.spec.ts`
- `src/composables/__tests__/usePhone.spec.ts`
- `src/lib/utils/__tests__/phone.spec.ts`

---

### 13. Documentation

**Задачи:**

- [ ] Дополнить `README.md`:
  - Архитектура проекта
  - Подробный setup guide
  - Deploy инструкции
  - API endpoints (когда будут)
  - Troubleshooting секция
- [ ] Создать `CONTRIBUTING.md`:
  - Code style guide
  - Git workflow (branches, commits)
  - Pull request процесс
  - Testing requirements
- [ ] Создать `API.md` документацию:
  - Все API endpoints
  - Request/Response примеры
  - Error codes
  - Authentication (если будет)
- [ ] Добавить inline комментарии для сложной логики
- [ ] Создать changelog (`CHANGELOG.md`)

**Файлы для создания:**

- `CONTRIBUTING.md`
- `API.md`
- `CHANGELOG.md`

---

### 14. Дополнительные фичи

**Задачи:**

- [ ] Реализовать страницу **Новости** (`NewsPage.vue`):
  - Список новостей
  - Детальная страница новости
  - Пагинация или infinite scroll
  - Фильтрация по категориям
- [ ] Реализовать страницу **Статистика** (`StatisticPage.vue`):
  - Графики пожертвований (Chart.js или Recharts)
  - Общая сумма собранных средств
  - Количество доноров
  - Топ-доноры (опционально)
  - Прогресс по проектам
- [ ] Добавить **историю пожертвований** для пользователя:
  - Личный кабинет (авторизация)
  - Список всех пожертвований
  - Статус каждого платежа
  - Скачивание чеков
- [ ] Добавить **рекуррентные платежи**:
  - Подписка на ежемесячные платежи
  - Управление подпиской
  - Отмена подписки

**Файлы для обновления:**

- `src/pages/NewsPage.vue`
- `src/pages/StatisticPage.vue`
- `src/pages/ProfilePage.vue` (новая)

---

## Краткая дорожная карта

### Неделя 1: Backend & Security (КРИТИЧНО)

- ✅ API integration (services, axios setup)
- ✅ Error handling (ErrorBoundary, global handler)
- ✅ Environment setup (.env files)
- ✅ SEO basics (title, meta tags, robots.txt)
- ✅ Security (CSP, CORS, HTTPS, headers)

### Неделя 2: Production Ready

- ✅ Deployment config (nginx, CI/CD)
- ✅ Logging & monitoring (Sentry, analytics)
- ✅ Performance optimization (images, compression, caching)
- ✅ Завершить функциональность (ResultForm, webhooks)
- ✅ Accessibility fixes

### Неделя 3: Testing & Polish

- ✅ E2E тесты доработать (edge cases)
- ✅ Unit тесты добавить (stores, composables, utils)
- ✅ Code refactoring (useDonationStore split)
- ✅ Remove magic strings
- ✅ Documentation (README, API.md)

### Неделя 4: Launch & Monitor

- ✅ Production deploy (staging → production)
- ✅ Monitoring setup и alerts
- ✅ Bug fixes (на основе feedback)
- ✅ Final documentation
- ✅ Post-launch optimization

---

## Детальный анализ качества кода

### ✅ Сильные стороны

#### 1. Архитектура и структура

- Четкое разделение ответственности (`stores/`, `components/`, `composables/`, `lib/`)
- Модульная структура с правильной организацией типов, констант и утилит
- Использование Composition API и TypeScript
- Разумное использование patterns (Page Object для тестов, composables для переиспользуемой логики)

#### 2. TypeScript и типизация

- Строгая типизация везде (strict mode в `tsconfig.json`)
- Хорошо продуманная система типов в `lib/types/`
- Правильное использование Zod для runtime валидации
- Отсутствие `any` (насколько видно из кода)

#### 3. Управление состоянием

- Корректное использование Pinia
- Computed properties для производных данных
- Reactive state management
- Отслеживание несохраненных изменений (`hasUnsavedData`)

#### 4. DRY принцип

- Переиспользуемые UI компоненты (shadcn-vue)
- Composables для общей логики (`usePhone`, `useSEO`, и т.д.)
- Константы вынесены в отдельные файлы (`lib/constants/`)
- Утилиты для повторяющихся операций (`lib/utils/`)

#### 5. Валидация

- Продуманная система валидации через Zod (`lib/validations/`)
- Кастомные правила (телефон через libphonenumber-js, возраст 18-100 лет)
- Понятные сообщения об ошибках на русском языке

---

### ⚠️ Недостатки и замечания

#### 1. Нарушение Single Responsibility Principle

**Файл:** `src/stores/donation.ts:76-268`

`useDonationStore` слишком большой (268 строк) и отвечает за:

- Управление формами (blank + payment)
- Валидацию обеих форм
- Навигацию между шагами (currentStep, nextStep, prevStep)
- Управление переходами (transitionDirection, isInitialLoad)
- Отслеживание изменений (hasUnsavedData)

**Рекомендация:** Разбить на несколько более специализированных stores или composables:

- `useBlankFormStore` - управление формой анкеты
- `usePaymentFormStore` - управление формой платежа
- `useStepManagement` - composable для навигации между шагами
- `useFormValidation` - composable для валидации

#### 2. Жесткая связанность (Tight Coupling)

**Файл:** `src/components/donation/forms/BlankForm.vue`

Прямое обращение к `donationStore` в компоненте создает tight coupling:

```vue
const donationStore = useDonationStore() const form = computed(() => donationStore.formData.blank)
```

**Рекомендация:** Использовать props/emits для передачи данных или provide/inject для более гибкой связи.

#### 3. Дублирование логики watch

**Файл:** `src/components/donation/forms/PaymentForm.vue:53-66`

Две похожие watch функции для синхронизации между `numberValue` и `form.value.amount`:

```typescript
const clearNumberValueWatch = watch(numberValue, (value) => {
  form.value.amount = value ?? 0
  donationStore.clearFieldError('payment', 'amount')
})

const clearFormAmountWatch = watch(
  () => form.value.amount,
  (value) => {
    if (value !== numberValue.value) {
      setValue(value ? value : null)
    }
  },
  { immediate: true }
)
```

**Рекомендация:** Можно упростить через `v-model` с custom getter/setter или использовать одну bidirectional watch.

#### 4. "Магические" строки в коде

**Примеры:**

```typescript
donationStore.clearFieldError('blank', 'phone') // 'blank', 'phone' - magic strings
formSchemas[formName].safeParse(formData[formName]) // 'formName' может быть любой строкой
```

**Рекомендация:** Использовать typed constants:

```typescript
const FORM_NAMES = {
  BLANK: 'blank',
  PAYMENT: 'payment',
} as const

const BLANK_FIELDS = {
  PHONE: 'phone',
  NAME: 'name',
  BIRTH: 'birth',
  IS_GROUP: 'isGroup',
} as const
```

#### 5. TODO комментарии в production коде

**Файл:** `src/stores/donation.ts:197-199`

```typescript
// TODO: В будущем здесь будет запрос на сервер для получения данных платежа
// const paymentData = await fetchPaymentByToken(paymentToken)
// donationStore.setPaymentResult(paymentData)
```

**Рекомендация:** Либо реализовать функциональность, либо создать issue в GitHub и удалить TODO.

---

## Готовность к продакшену - детали

### ❌ Критические проблемы

#### 1. Отсутствие Backend интеграции

- Нет API слоя (нет `src/services/`, нет `src/api/`)
- Нет реальной обработки платежей (только mock данные)
- Нет сохранения данных на сервер
- `axios@1.10.0` в dependencies, но не используется нигде

**Что нужно:**

- Создать API client (axios instance)
- Реализовать donation service (создание, получение статуса)
- Реализовать payment service (обработка платежей)
- Интеграция с платежным шлюзом (YooKassa, CloudPayments, и т.д.)

#### 2. Отсутствие переменных окружения

- Нет `.env` файла
- Нет `.env.example` с шаблоном
- Некуда добавить `API_URL`, `PAYMENT_API_KEY`, и т.д.

**Что нужно:**

- Создать `.env.example`
- Настроить типизацию для `import.meta.env`
- Разделить конфиги для dev/staging/prod

#### 3. Отсутствие обработки ошибок

- Нет `ErrorBoundary` компонента
- Нет глобальной обработки ошибок в `main.ts`
- Только один `console.error` в `donation.ts:136`
- Нет retry логики для запросов

**Что нужно:**

- Error Boundary для Vue компонентов
- Global error handler (`app.config.errorHandler`)
- Composable для обработки ошибок API
- User-friendly error messages

#### 4. SEO проблемы

- `index.html` не имеет `<title>` (title устанавливается только через `guards.ts:11`)
- Отсутствуют базовые meta теги в `index.htmlhttps://www.behance.net`
- Нет `robots.txt`
- Нет `sitemap.xml`
- Нет OG image (`guards.ts:20` закомментировано)

**Что нужно:**

- Добавить fallback `<title>` в index.html
- Добавить meta description, keywords, author
- Создать robots.txt и sitemap.xml
- Подготовить OG image (1200x630px)

#### 5. Безопасность

- Нет Content Security Policy (CSP)
- Нет security headers (X-Frame-Options, X-Content-Type-Options)
- Нет rate limiting (будет на бэкенде)
- Нет CSRF защиты (потребуется когда будет бэкенд)
- Нет санитизации пользовательского ввода (XSS защита)

**https://www.behance.netЧто нужно:**

- CSP через nginx или Vite plugin
- Security headers в nginx
- Санитизация user input (DOMPurify или встроенная)
- HTTPS с Let's Encrypt

#### 6. Performance

- Нет кеширования (Cache-Control headers)
- Нет оптимизации изображений (hero.jpg весит много)
- Нет lazy loading для images
- Нет compression (gzip/brotli)

**Что нужно:**

- Оптимизировать изображения (WebP, сжатие)
- Настроить caching в nginx
- Добавить `loading="lazy"` для images
- Включить compression в nginx

---

### ⚠️ Важные недоработки

#### 1. Логирование и мониторинг

- Только `console.error` в одном месте
- Нет системы логирования (logger utility)
- Нет Sentry для error tracking
- Нет analytics (Google Analytics, Yandex Metrika)

#### 2. Недостаточная документация

- Нет API документации (потому что нет API)
- Нет `CONTRIBUTING.md` guide
- `README.md` содержит только базовую информацию
- Нет deployment инструкций

#### 3. Build и deploy

- Нет CI/CD конфигурации (GitHub Actions, GitLab CI)
- Нет Docker файлов
- Нет deployment инструкций
- Нет nginx конфига

#### 4. Настройки production

- `vite.config.ts:24` содержит dev сервер настройки (`.lhr.life`)
- Нет отдельной production конфигурации
- Нет оптимизации bundle size (нужно проверить)
- Нет tree-shaking анализа

#### 5. Страницы-заглушки

- `NewsPage.vue` - пустая страница
- `StatisticPage.vue` - пустая страница

Содержат только placeholder контент.

#### 6. Accessibility

- Нет `aria-label` для важных элементов
- Отсутствует focus management (автофокус, trap focus)
- Нет keyboard navigation тестов
- Не проверен screen reader support

---

## Заключение

**Проект находится в хорошем состоянии** с точки зрения кода и архитектуры, но **требует значительных доработок** перед production запуском.

**Основные направления:**

1. Backend integration (API layer, payment processing)
2. Security и production configuration
3. Error handling и monitoring
4. SEO и performance optimization
5. Accessibility и UX improvements

**Приоритет:** Сначала реализовать Приоритет 1 (критичные задачи), затем Приоритет 2 (важные), и только потом Приоритет 3 (улучшения).

**Рекомендация:** Начать с Backend Integration и Environment Configuration, так как это основа для всех остальных задач.
